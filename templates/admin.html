{% extends 'base.html' %}

{% block title %}بوابة المشرفين - طلبات بطاقة الحج{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <div class="d-flex align-items-center">
                    <h2 class="h4 mb-0 ml-3">إدارة طلبات بطاقة الحج</h2>
                </div>
                <div class="d-flex align-items-center">
                    <div class="form-group mb-0 ms-3">
                        <div class="input-group">
                            <input type="number" id="totalHajjInput" class="form-control" placeholder="إجمالي عدد الحجاج" value="{{ total_hajj }}">
                            <button class="btn btn-primary" onclick="updateTotalHajj()">
                                <i class="fas fa-save ms-1"></i>حفظ
                            </button>
                        </div>
                    </div>
                    <span id="requestCount" class="badge bg-info ms-2"></span>
                </div>
            </div>
            <div class="table-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" class="form-control search-input" placeholder="البحث بالاسم، رقم الجواز...">
                </div>
                <select id="statusFilter" class="form-select filter-dropdown">
                    <option value="all">جميع الحالات</option>
                    <option value="found">تم العثور عليها</option>
                    <option value="request sent">تم إرسال الطلب</option>
                    <option value="card received">تم استلام البطاقة</option>
                    <option value="card delivered">تم تسليم البطاقة</option>
                </select>
                <select id="reasonFilter" class="form-select filter-dropdown">
                    <option value="all">جميع الأسباب</option>
                    <option value="Lost Card">بطاقة مفقودة</option>
                    <option value="Damaged Card">بطاقة تالفة</option>
                </select>
                <select id="writtenFilter" class="form-select filter-dropdown">
                    <option value="all">جميع حالات الطلب</option>
                    <option value="true">تم رفع الطلب</option>
                    <option value="false">لم يرفع الطلب</option>
                </select>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="requestsTable">
                        <thead class="table-light">
                            <tr>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 0)">المعرف <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 1)">الموظف <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 2)">اسم الحاج <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 3)">رقم الجواز <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 4)">رقم التأشيرة <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 5)">السبب <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 6)">إرجاع البطاقة <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 7)">الحالة <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 8)">الكتابة <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortTable(document.getElementById('requestsTable'), 9)">تاريخ الإنشاء <i class="fas fa-sort ms-1"></i></th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in requests %}
                            <tr data-status="{{ req.status }}" data-reason="{{ req.request_reason }}" data-written="{{ req.is_written|lower }}">
                                <td>{{ req.id }}</td>
                                <td>
                                    <div>{{ req.employee_name }}</div>
                                    <small class="text-muted">{{ req.employee_number }}</small>
                                </td>
                                <td>{{ req.hajj_name }}</td>
                                <td>{{ req.passport_number }}</td>
                                <td>{{ req.visa_number }}</td>
                                <td>
                                    {% if req.request_reason == "Lost Card" %}
                                        بطاقة مفقودة
                                    {% else %}
                                        بطاقة تالفة
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.request_reason == "Damaged Card" %}
                                        {% if req.card_returned %}
                                            <span class="badge bg-success">نعم</span>
                                        {% else %}
                                            <span class="badge bg-danger">لا</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">غير متاح</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="form-select form-select-sm status-select" 
                                            data-request-id="{{ req.id }}" 
                                            onchange="updateStatus(this)">
                                        <option value="found" {% if req.status == 'found' %}selected{% endif %}>تم العثور عليها</option>
                                        <option value="request sent" {% if req.status == 'request sent' %}selected{% endif %}>تم إرسال الطلب</option>
                                        <option value="card received" {% if req.status == 'card received' %}selected{% endif %}>تم استلام البطاقة</option>
                                        <option value="card delivered" {% if req.status == 'card delivered' %}selected{% endif %}>تم تسليم البطاقة</option>
                                    </select>
                                </td>
                                <td>
                                    {% if req.request_upload %}
                                        <span class="badge bg-success">نعم</span>
                                    {% else %}
                                        <span class="badge bg-secondary">لا</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.created_at %}
                                        {{ req.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center py-4">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="mb-0">لم يتم العثور على طلبات في النظام.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0">إرشادات للمشرفين</h3>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>معالجة الطلبات بسرعة لتقليل وقت الانتظار</li>
                    <li>التحقق من جميع المعلومات قبل المعالجة</li>
                    <li>تحديد الطلبات كمكتوبة بمجرد أن تكون البطاقة الفعلية جاهزة</li>
                    <li>استخدام "إلغاء المعالجة" للطلبات التي تمت معالجتها بالخطأ</li>
                    <li>الاتصال بالموظف إذا كانت هناك حاجة لمعلومات إضافية</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0">ملخص الحالة</h3>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="p-3 border rounded mb-2">
                            <h3 class="h2 mb-0" id="newRequestsCount">0</h3>
                        </div>
                        <div class="text-muted">طلبات جديدة</div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 border rounded mb-2">
                            <h3 class="h2 mb-0" id="processedRequestsCount">0</h3>
                        </div>
                        <div class="text-muted">تمت المعالجة</div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 border rounded mb-2">
                            <h3 class="h2 mb-0" id="writtenRequestsCount">0</h3>
                        </div>
                        <div class="text-muted">تمت الكتابة</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateStatus(selectElement) {
    const requestId = selectElement.dataset.requestId;
    const newStatus = selectElement.value;
    
    $.ajax({
        url: `/update_status/${requestId}`,
        method: 'POST',
        data: { status: newStatus },
        success: function(response) {
            if (response.success) {
                // Show success message
                const successAlert = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                    تم تحديث الحالة بنجاح
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                $('.container').prepend(successAlert);
                
                // Update status badge styling
                const row = $(selectElement).closest('tr');
                row.attr('data-status', newStatus);
            }
        },
        error: function(error) {
            // Show error message
            const errorAlert = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                حدث خطأ أثناء تحديث الحالة
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            $('.container').prepend(errorAlert);
        }
    });
}

function getArabicStatus(status) {
    const statusMap = {
        'found': 'تم العثور عليها',
        'request sent': 'تم إرسال الطلب',
        'card received': 'تم استلام البطاقة',
        'card delivered': 'تم تسليم البطاقة'
    };
    return statusMap[status] || status;
}

// Update filtering to use new status values
$(document).ready(function() {
    // Count and display total requests
    updateRequestCount();
    
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const reasonFilter = document.getElementById('reasonFilter');
    
    searchInput.addEventListener('keyup', filterTable);
    statusFilter.addEventListener('change', filterTable);
    reasonFilter.addEventListener('change', filterTable);
    
    function filterTable() {
        const searchValue = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const reasonValue = reasonFilter.value;
        
        const rows = $('#requestsTable tbody tr').not(':has(td[colspan])');
        
        let visibleCount = 0;
        
        rows.each(function() {
            const row = $(this);
            const status = row.data('status');
            const reason = row.data('reason');
            const text = row.text().toLowerCase();
            
            const statusMatch = statusValue === 'all' || status === statusValue;
            const reasonMatch = reasonValue === 'all' || reason === reasonValue;
            const textMatch = text.includes(searchValue);
            
            if (statusMatch && reasonMatch && textMatch) {
                row.show();
                visibleCount++;
            } else {
                row.hide();
            }
        });
        
        $('#requestCount').text(`${visibleCount} طلب`);
    }
});
</script>
{% endblock %}